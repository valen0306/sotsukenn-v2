## 今後の方針 v2（改訂版：Phase5到達を前提）

### 1. 方針の結論

- **第1貢献（確定）**: A3（Localizer + Reranker）はA1より `tsc` 回数を削減できた → **「探索効率化」**は成立
- **次の本命（第2貢献）**: Top1を超える候補がほぼ存在しない（`win_rate_vs_top1=0`）ため、Reranker改良だけでは指標が動かない  
  ⇒ 研究の中心を **Candidate Generator v3（Repair Operator）** に移す

---

### 2. 次フェーズで狙うこと

- Top1注入後に残る `tsc` エラーに対し、**エラー型に直結する“局所型修復”**を生成して  
  **`win_rate_vs_top1 > 0`** を出す（＝改善が起きる世界を作る）
- 悪化率（worse）の低下は、学習器強化より先に **選択ポリシー（セーフガード）**で抑える

---

### 3. まず入れるべき分析（重要）

- **Oracle分析**: 候補集合内で「最良候補（Δphase3最小）」を後から選ぶ上限を算出し、
  - oracleでもTop1を超えない → **候補集合が律速（生成器が本命で確定）**
  - oracleは超える → **rerank/localizeにも改善余地**
  を定量で示す（論文/卒論の説得力が一段上がる）

---

### 4. Candidate Generator v3（Repair Operator）の方向性

`tsc` のエラー型ごとに「刺さる少数候補」を作る（候補数を増やして `tsc` 回数を爆増させない）：

- **TS2345 / TS2322（型不一致）**: 当該引数だけ `unknown` / `union` / `optional` / `nullable` に局所拡張
- **TS2339（プロパティ不存在）**: index signature追加・Record化・交差型で補強
- **複合ケース**: overload追加（引数個数/型別）
- **exports / 解決**: missing exports補完・namespace member生成（ただしエラー起点で狙い撃ち）

---

### 5. 悪化率を下げる（モデルより先にポリシー）

- **セーフガード**: 採用前に少数consumerで事前評価→悪化なら棄却
- **tiesが多い前提の早期停止**: 同点が続くなら探索終了（無駄試行と悪化機会を減らす）

---

### 6. 次の3週間ロードマップ（短期で成果を出す順）

- **Week 1**: oracle分析 / エラーコード分布 / Δを動かした宣言抽出（設計の根拠固め）
- **Week 2**: Repair Operator v3実装（TS2345・TS2339・overloadを優先）
- **Week 3**: セーフガード導入＋統合評価（A3 + Gen v3）  
  → 目標：`win_rate_vs_top1` を動かす ＆ `worse` を下げる/同等 ＆ `avg_tsc_calls` 維持

---

### 7. M4 32GB 前提の方針

- 重いのは学習ではなく `tsc` 回数  
  ⇒ 「候補を大量生成」ではなく **「当たる少数候補を生成」**に寄せる
- Rerankerは当面 軽量MLで十分。候補集合が強くなった後にモデル強化を検討


